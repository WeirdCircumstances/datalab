{% extends "base.html" %}

{% load wagtailcore_tags django_htmx static wagtailimages_tags i18n %}

{% block body_class %}template-homepage{% endblock %}

{% block content %}

    {% include_block page.header %}

    <!-- optionally define the sidebar content via HTML markup -->
    <div id="sidebar" class="leaflet-sidebar collapsed">

        <!-- nav tabs -->
        <div class="leaflet-sidebar-tabs">
            <!-- top aligned tabs -->
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fa-solid fa-bars active mx-1"></i></a></li>
                <li>
                    <a href="#temp" class="show_button" role="tab"
                       hx-get="draw_hexmap/temp"
                       hx-target="#temp_graph"
                       hx-swap="innerHTML swap:1s"
                       id="temp_map_link">
                        <i class="fa-solid fa-temperature-low"></i>
                    </a>
                </li>
                <li>
                    <a href="#dust" class="show_button" role="tab"
                       hx-get="draw_hexmap/dust"
                       hx-target="#dust_graph"
                       hx-swap="innerHTML swap:0.6s"
                       id="dust_map_link">
                        <i class="fa-solid fa-sun-haze"></i>
                    </a>
                </li>
                <li>
                    <a href="#refreshing" class="show_button" role="tab"
                       hx-get="erfrischungskarte/14Uhr"
                       hx-target="#refreshing_graph"
                       hx-swap="innerHTML swap:0.6s"
                       id="refreshing_map_link">
                        <i class="fa-solid fa-glass-citrus"></i>
                    </a>
                </li>
                <li>
                    <a href="#refreshing_gif" class="show_button" role="tab">
                        <i class="fa-solid fa-gif"></i>
                    </a>
                </li>
                <li>
                    <a href="#show_by_tag" class="show_button" role="tab"
                       hx-get="show_by_tag/all?tag=HU+Explorers"
                       hx-target="#show_by_tag_graph"
                       hx-swap="innerHTML swap:0.6s"
                       id="show_by_tag_link">
                        <i class="fa-solid fa-tag"></i>
                    </a>
                </li>
            </ul>

            <ul role="tablist">
                <li><a href="#settings" role="tab"><i class="fa-solid fa-gear"></i></a></li>
            </ul>

        </div>

        <!-- panel content -->
        <div class="leaflet-sidebar-content">
            <div class="leaflet-sidebar-pane" id="home">
                <h1 class="leaflet-sidebar-header">
                    Humboldt Explorers - SenseBox
                    <span class="leaflet-sidebar-close"><i class="fa-solid fa-xmark"></i></span>
                </h1>


                {% for block in page.body %}
                    {% include_block block %}
                {% endfor %}

                <p>
                    Hier habt ihr die Möglichkeit euch die Umweltdaten von SenseBoxen anzuschauen.
                </p>

                <div id="sensebox_graph"></div>

            </div>

            <div class="leaflet-sidebar-pane" id="temp" style="height: 90vh;">
                <h1 class="leaflet-sidebar-header">
                    Temperatur im Verlauf der letzten 48 Stunden
                    <span class="leaflet-sidebar-close"><i class="fa-solid fa-xmark"></i></span>
                </h1>

                <div class="spinner" id="temp_graph" style="height: 100vh; min-height: 100vh; position: relative;"></div>
            </div>

            <div class="leaflet-sidebar-pane" id="dust" style="height: 90vh;">
                <h1 class="leaflet-sidebar-header">
                    Feinstaub im Verlauf der letzten 48 Stunden (PM10)
                    <span class="leaflet-sidebar-close"><i class="fa-solid fa-xmark"></i></span>
                </h1>

                <div class="spinner" id="dust_graph" style="height: 100vh; position: relative;"></div>

            </div>

            <div class="leaflet-sidebar-pane" id="refreshing" style="height: 90vh;">
                <h1 class="leaflet-sidebar-header">
                    Erfrischungskarte
                    <span class="leaflet-sidebar-close"><i class="fa-solid fa-xmark"></i></span>
                </h1>

                <div class="d-grid gap-2 d-md-block mt-4">
                    <a type="button" class="show_button btn btn-outline-dark"
                       hx-get="erfrischungskarte/9Uhr"
                       hx-target="#refreshing_graph"
                       hx-swap="innerHTML swap:0.6s">
                        9 Uhr
                    </a>
                    <a type="button" class="show_button btn btn-outline-dark active"
                       hx-get="erfrischungskarte/14Uhr"
                       hx-target="#refreshing_graph"
                       hx-swap="innerHTML swap:0.6s">
                        14 Uhr
                    </a>
                    <a type="button" class="show_button btn btn-outline-dark"
                       hx-get="erfrischungskarte/21Uhr"
                       hx-target="#refreshing_graph"
                       hx-swap="innerHTML swap:0.6s">
                        21 Uhr
                    </a>
                </div>

                <div class="spinner" id="refreshing_graph"></div>

            </div>


            <div class="leaflet-sidebar-pane" id="refreshing_gif">
                <h1 class="leaflet-sidebar-header">
                    Erfrischungsanimation
                    <span class="leaflet-sidebar-close"><i class="fa-solid fa-xmark"></i></span>
                </h1>
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-12">
                            <!-- Eltern-Div für feste Größe (optional, falls keine andere Größenbeschränkung vorliegt) -->
                            <div> {# class="position-relative" style="height: 100%;" #}
                                <!-- GIF, das die Größe des Elternelements vollständig einnimmt -->
                                <img src="{% static 'gifs/animation.gif' %}" class="img-fluid"
                                     alt="{% translate "Eine Animation der Erfrischungskarte, die angenehme Orte im berliner Sommer darstellt." %}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="leaflet-sidebar-pane" id="show_by_tag">
                <h1 class="leaflet-sidebar-header">
                    DataLab Dashboard
                    <span class="leaflet-sidebar-close"><i class="fa-solid fa-xmark"></i></span>
                </h1>
                <div class="spinner" id="show_by_tag_graph"></div>
            </div>

            <div class="leaflet-sidebar-pane" id="settings">
                <h1 class="leaflet-sidebar-header">
                    {% translate 'Einstellungen' %}
                    <span class="leaflet-sidebar-close"><i class="fa-solid fa-xmark"></i></span>
                </h1>

                <a type="button" class="show_button btn btn-outline-dark" href="/cms" target="_blank">
                    {% translate 'CMS' %}
                </a>

                <br>

                <a type="button" class="show_button btn btn-outline-dark" href="/admin" target="_blank">
                    {% translate 'Admin Panel' %}
                </a>
            </div>

        </div>
    </div>

    <div id="map">

        <script>

            // https://leafletjs.com/examples/layers-control/

            var arial = L.tileLayer(`maptiler_satellite_v2/{z}/{x}/{y}`, {
                tileSize: 512,
                zoomOffset: -1,
                maxZoom: 22,
                minZoom: 10,
                attribution: "\u003ca href=\"https://www.maptiler.com/copyright/\" target=\"_blank\"\u003e\u0026copy; MapTiler\u003c/a\u003e \u003ca href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\"\u003e\u0026copy; OpenStreetMap contributors\u003c/a\u003e",
                crossOrigin: true
            });

            const osm = L.tileLayer('osm_tiles/{z}/{x}/{y}', {
                maxZoom: 22,
                minZoom: 10,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            });

            var osmb = new OSMBuildings(map).load('osm_buildings/{z}/{x}/{y}');

            baseMaps = {
                'OSM': osm,
                'Satellit': arial,
            }

            // define empty overlayMaps, to be able to enter a unchecked osmb
            overlayMaps = {};

            // the map is created here
            var map = L.map('map', {
                center: [52.516221, 13.3992],
                zoom: 11,
                layers: [osm], // define, what should be shown first
            });

            var layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);

            layerControl.addOverlay(osmb, 'OSM Buildings');

            var blueIcon = new L.Icon({
                iconUrl: '{% static 'icons/marker-icon-blue.png' %}',
                shadowUrl: '{% static 'icons/marker-shadow.png' %}',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var greyIcon = new L.Icon({
                iconUrl: '{% static 'icons/marker-icon-grey.png' %}',
                shadowUrl: '{% static 'icons/marker-shadow.png' %}',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            var lc = L.control.locate({
                flyTo: true,
            }).addTo(map);
        </script>

        {{ map_scripts|safe }}

        <script>
            // create the sidebar instance and add it to the map
            var sidebar = L.control.sidebar({
                container: 'sidebar',
                position: 'left',
            }).addTo(map);
            {#.open('home');#}

            // be notified when a panel is opened
            sidebar.on('content', function (ev) {
                switch (ev.id) {
                    case 'autopan':
                        sidebar.options.autopan = true;
                        break;
                    default:
                        sidebar.options.autopan = false;
                }
            });
        </script>

        <script>
            var refreshingSpinner = document.getElementsByClassName('show_button');

            function showSpinner() {
                var targets = document.getElementsByClassName('spinner');

                for (let i = 0; i < targets.length; i++) {
                    targets[i].innerHTML = `<div class="d-flex flex-column justify-content-center align-items-center min-vh-100"><div class="spinner-border" role="status" style="width: 6rem; height: 6rem;"><span class="visually-hidden">Loading...</span></div><strong role="status" class="mt-3">Lade Daten ...</strong></div>`;
                }
            }

            for (let i = 0; i < refreshingSpinner.length; i++) {
                refreshingSpinner[i].addEventListener("click", function (event) {
                    showSpinner();
                });
            }
        </script>
    </div>

{% endblock %}
